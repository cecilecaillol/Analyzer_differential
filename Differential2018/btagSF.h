double GetSF(int WP, float x, int flavour, int syst){

   if (WP==1){
      if (fabs(flavour)==4 or fabs(flavour)==5){
        if (syst==0 or syst==2 or syst==-2){
	   return 0.909339+(0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))));
        }
        if (fabs(flavour)==4 and syst==-1){
           if (x>=20 and x<30) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.19771461188793182);
           if (x>=30 and x<50) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.045167062431573868);
           if (x>=50 and x<70) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.040520280599594116);
           if (x>=70 and x<100) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.045320175588130951);
           if (x>=100 and x<140) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.043860536068677902);
           if (x>=140 and x<200) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.036484666168689728);
           if (x>=200 and x<300) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.048719070851802826);
           if (x>=300 and x<600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.11997123062610626);
           if (x>=600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.20536302030086517);
        }
        if (fabs(flavour)==4 and syst==1){
           if (x>=20 and x<30) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.19771461188793182);
           if (x>=30 and x<50) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.045167062431573868);
           if (x>=50 and x<70) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.040520280599594116);
           if (x>=70 and x<100) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.045320175588130951);
           if (x>=100 and x<140) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.043860536068677902);
           if (x>=140 and x<200) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.036484666168689728);
           if (x>=200 and x<300) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.048719070851802826);
           if (x>=300 and x<600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.11997123062610626);
           if (x>=600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.20536302030086517);
        }
        if (fabs(flavour)==5 and syst==-1){
           if (x>=20 and x<30) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.065904870629310608);
           if (x>=30 and x<50) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.015055687166750431);
           if (x>=50 and x<70) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.013506759889423847);
           if (x>=70 and x<100) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.015106724575161934);
           if (x>=100 and x<140) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.014620178379118443);
           if (x>=140 and x<200) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.012161554768681526);
           if (x>=200 and x<300) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.016239689663052559);
           if (x>=300 and x<600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.039990410208702087);
           if (x>=600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))-0.068454340100288391);
        }
        if (fabs(flavour)==5 and syst==1){
           if (x>=20 and x<30) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.065904870629310608);
           if (x>=30 and x<50) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.015055687166750431);
           if (x>=50 and x<70) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.013506759889423847);
           if (x>=70 and x<100) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.015106724575161934);
           if (x>=100 and x<140) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.014620178379118443);
           if (x>=140 and x<200) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.012161554768681526);
           if (x>=200 and x<300) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.016239689663052559);
           if (x>=300 and x<600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.039990410208702087);
           if (x>=600) return 0.909339+((0.00354*(log(x+19)*(log(x+18)*(3-(0.471623*log(x+18))))))+0.068454340100288391);
        }
      }
      else {
        if (syst==0 or syst==1 or syst==-1) return 1.6329+-0.00160255*x+1.9899e-06*x*x+-6.72613e-10*x*x*x;
     }
   }
   else return 0;
}


double bTagEventWeight(int nBtaggedJets, float bjetpt_1, int bjetflavour_1, float bjetpt_2, int bjetflavour_2, int WP, int syst, int nBTags)
{
  if (nBtaggedJets > 2) return -10000;
  if( nBTags > 2 ) return -10000;

  /*
    ##################################################################
    Event weight matrix:
    ------------------------------------------------------------------
    nBTags\b-tagged jets  |    0        1             2
    ------------------------------------------------------------------
      0                   |    1      1-SF      (1-SF1)(1-SF2)
                          |
      1                   |    0       SF    SF1(1-SF2)+(1-SF1)SF2
                          |
      2                   |    0        0           SF1SF2
    ##################################################################
  */
  
  if( nBTags > nBtaggedJets) return 0;
  if( nBTags==0 && nBtaggedJets==0) return 1;

  double weight = 0;
  if(nBtaggedJets==1){
    double SF = GetSF(WP,bjetpt_1,bjetflavour_1,syst);
    for( unsigned int i=0; i<=1; ++i ){
      if( i != nBTags ) continue;
      weight += pow(SF,i)*pow(1-SF,1-i);
    }
  }
  else if(nBtaggedJets==2 ){
    double SF1 = GetSF(WP,bjetpt_1,bjetflavour_1,syst);
    double SF2 = GetSF(WP,bjetpt_2,bjetflavour_2,syst);
    
    for( unsigned int i=0; i<=1; ++i ){
      for( unsigned int j=0; j<=1; ++j ){
        if( (i+j) != nBTags ) continue;
        weight += pow(SF1,i)*pow(1-SF1,1-i)*pow(SF2,j)*pow(1-SF2,1-j);
      }
    }
  }
  return weight;
}

